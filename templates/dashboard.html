<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITK Air Quality - Offline</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {margin:0; padding:0; box-sizing:border-box;}
        body {font-family:system-ui; background:#f5f5f7; overflow-x: hidden;}
        .header {background:#fff; padding:16px 24px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;}
        .header h1 {color:#007AFF; font-size:24px;}
        .status {padding:6px 12px; background:#e3f2fd; border-radius:16px; font-size:14px; color:#1976d2;}
        .container {display:grid; grid-template-columns:1fr 300px; gap:20px; padding:20px; height:calc(100vh - 73px);}
        .map-section {background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.08); display:flex; flex-direction:column; overflow:hidden;}
        .map-header {padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;}
        #map {flex:1; min-height:400px; background:#f5f5f5;}
        .btn {padding:8px 16px; background:#007AFF; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:500; transition: all 0.2s ease;}
        .btn:hover {background:#0056CC; transform: translateY(-1px);}
        .btn:disabled {background:#ccc; cursor:not-allowed; transform: none;}
        .btn-secondary {background:#e0e0e0; color:#333;}
        .btn-secondary:hover {background:#d0d0d0;}
        .sidebar {display:flex; flex-direction:column; gap:16px; position:relative;}
        .widget {background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s ease;}
        .widget h4 {margin-bottom:16px; color:#333;}
        .aqi-display {text-align:center; padding:24px; background:#f0f9ff; border-radius:12px; margin-bottom:16px;}
        .aqi-value {font-size:48px; font-weight:700; color:#007AFF; margin:8px 0;}
        .metrics {display:grid; grid-template-columns:1fr 1fr; gap:10px;}
        .metric {background:#fafafa; padding:14px; border-radius:8px; text-align:center;}
        .metric strong {display:block; font-size:20px; color:#333; margin-bottom:4px;}
        
        /* Data Collection Card */
        .collection-card {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 350px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(370px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: calc(100vh - 120px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .collection-card.visible {
            transform: translateX(0);
        }
        
        .collection-card.minimized {
            width: 280px;
            height: 120px;
        }
        
        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px 16px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .collection-header h3 {
            font-size: 18px;
            margin: 0;
        }
        
        .header-controls {
            display: flex;
            gap: 8px;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .collection-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .minimized .collection-content {
            padding: 16px 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: #fafbfc;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #007AFF;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .coord-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .location-info {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            margin: 16px 0;
        }
        
        .progress-section {
            margin: 20px 0;
            display: none;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .progress-header h5 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        
        .progress-stats {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007AFF, #0056CC);
            transition: width 0.5s ease;
            width: 0%;
            border-radius: 6px;
        }
        
        .live-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .live-metric {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .live-metric .value {
            font-size: 18px;
            font-weight: 700;
            color: #007AFF;
            display: block;
            margin-bottom: 4px;
        }
        
        .live-metric .label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .chart-container {
            margin: 20px 0;
            height: 200px;
            position: relative;
            display: none;
        }
        
        .minimized .chart-container {
            display: none;
        }
        
        .minimized .form-group {
            display: none;
        }
        
        .minimized .progress-section {
            margin: 0;
        }
        
        .minimized .live-metrics {
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 12px 0 0 0;
        }
        
        .minimized .live-metric {
            padding: 8px 4px;
        }
        
        .minimized .live-metric .value {
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .minimized .live-metric .label {
            font-size: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .action-buttons .btn {
            flex: 1;
            padding: 12px;
            font-weight: 600;
            border-radius: 10px;
        }
        
        .minimized .action-buttons {
            display: none;
        }
        
        .quick-actions {
            display: none;
            gap: 8px;
            margin-top: 12px;
        }
        
        .minimized .quick-actions {
            display: flex;
        }
        
        .quick-btn {
            flex: 1;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .quick-btn:hover {
            background: #e9ecef;
            border-color: #007AFF;
            color: #007AFF;
        }
        
        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .collecting {
            animation: pulse 2s infinite;
        }
        
        /* Map markers */
        .aqi-marker {
            background:#fff; 
            border:3px solid #007AFF; 
            border-radius:50%; 
            width:40px; 
            height:40px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            font-weight:bold; 
            font-size:14px;
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
            cursor:pointer;
        }
        .aqi-good {background:#4caf50; color:white; border-color:#4caf50;}
        .aqi-moderate {background:#ffc107; color:white; border-color:#ffc107;}
        .aqi-unhealthy-sensitive {background:#ff9800; color:white; border-color:#ff9800;}
        .aqi-unhealthy {background:#f44336; color:white; border-color:#f44336;}
        .aqi-very-unhealthy {background:#9c27b0; color:white; border-color:#9c27b0;}
        
        /* Responsive */
        @media (max-width:768px) {
            .container {grid-template-columns:1fr; padding:10px;}
            .collection-card {
                top: 80px;
                right: 10px;
                left: 10px;
                width: auto;
                transform: translateY(100vh);
            }
            .collection-card.visible {
                transform: translateY(0);
            }
            .collection-card.minimized {
                bottom: 20px;
                top: auto;
                width: 200px;
                left: auto;
                right: 10px;
                transform: translateY(0);
            }
        }
        
        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }
        
        .fab:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(0, 122, 255, 0.4);
        }
        
        .fab.hidden {
            transform: translateY(100px) scale(0.8);
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🌱 NITK Air Quality Monitor</h1>
        <div class="status" id="status">Initializing...</div>
    </div>
    
    <div class="container">
        <div class="map-section">
            <div class="map-header">
                <h3>Campus Air Quality Map</h3>
                <div style="color: #666; font-size: 14px;">
                    📍 Click "Collect Data" to start monitoring at any location
                </div>
            </div>
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <div class="widget">
                <h4>Current Air Quality</h4>
                <div class="aqi-display">
                    <div>Air Quality Index</div>
                    <div class="aqi-value" id="aqi">--</div>
                    <div id="aqi-status">Measuring...</div>
                </div>
                <div class="metrics">
                    <div class="metric"><strong id="pm25">--</strong><span>PM2.5 μg/m³</span></div>
                    <div class="metric"><strong id="pm10">--</strong><span>PM10 μg/m³</span></div>
                    <div class="metric"><strong id="temp">--</strong><span>Temperature °C</span></div>
                    <div class="metric"><strong id="humidity">--</strong><span>Humidity %</span></div>
                </div>
            </div>
            
            <div class="widget">
                <h4>System Status</h4>
                <div id="collection-status">Ready to collect data at any campus location</div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" id="fabBtn" onclick="openCollectionCard()">📊</button>
    
    <!-- Data Collection Card -->
    <div class="collection-card" id="collectionCard">
        <div class="collection-header">
            <h3 id="cardTitle">📊 Data Collection</h3>
            <div class="header-controls">
                <button class="control-btn" onclick="toggleMinimize()" id="minimizeBtn">−</button>
                <button class="control-btn" onclick="closeCollectionCard()">×</button>
            </div>
        </div>
        
        <div class="collection-content">
            <form id="collectionForm" onsubmit="startCollection(event)">
                <div class="form-group">
                    <label>📍 Location Name</label>
                    <input type="text" id="location" placeholder="e.g., Main Building, Library Gate" required>
                </div>
                
                <div class="form-group">
                    <label>🗺️ Coordinates</label>
                    <div class="coord-inputs">
                        <input type="number" id="latitude" placeholder="Latitude" step="0.000001" min="13.004" max="13.018" required>
                        <input type="number" id="longitude" placeholder="Longitude" step="0.000001" min="74.780" max="74.802" required>
                    </div>
                </div>
                
                <div class="location-info">
                    ⏱️ Collection duration: 2 minutes<br>
                    📊 Monitors PM2.5, PM10, Temperature & Humidity
                </div>
            </form>
            
            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <div class="progress-header">
                    <h5>🔴 Collecting Data</h5>
                    <div class="progress-stats" id="progressStats">0% • 0s / 120s</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="live-metrics" id="liveMetrics">
                    <div class="live-metric">
                        <span class="value" id="livePM25">--</span>
                        <span class="label">PM2.5</span>
                    </div>
                    <div class="live-metric">
                        <span class="value" id="livePM10">--</span>
                        <span class="label">PM10</span>
                    </div>
                    <div class="live-metric">
                        <span class="value" id="liveTemp">--</span>
                        <span class="label">Temp</span>
                    </div>
                    <div class="live-metric">
                        <span class="value" id="liveHumidity">--</span>
                        <span class="label">Humidity</span>
                    </div>
                </div>
            </div>
            
            <!-- Live Chart -->
            <div class="chart-container" id="chartContainer">
                <canvas id="liveChart"></canvas>
            </div>
            
            <div class="action-buttons" id="actionButtons">
                <button type="button" onclick="closeCollectionCard()" class="btn btn-secondary">Cancel</button>
                <button type="submit" form="collectionForm" class="btn" id="startBtn">Start Collection</button>
            </div>
            
            <div class="quick-actions" id="quickActions">
                <button class="quick-btn" onclick="toggleMinimize()">Expand</button>
                <button class="quick-btn" onclick="stopCollection()">Stop</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map, collectionInterval, updateInterval, liveChart;
        let collectionStartTime, collectionData = [];
        let isMinimized = false, isCollecting = false;
        let allReadings = {};
        const COLLECTION_DURATION = 120; // 2 minutes
        const NITK = {center:[13.01081689345183,74.79424209021532], bounds:{north:13.018,south:13.004,east:74.802,west:74.780}, minZoom:14, maxZoom:19};
        
        function initMap() {
            map = L.map('map', {
                center: NITK.center, zoom: 16, minZoom: NITK.minZoom, maxZoom: NITK.maxZoom,
                maxBounds: [[NITK.bounds.south-0.001, NITK.bounds.west-0.001], [NITK.bounds.north+0.001, NITK.bounds.east+0.001]],
                maxBoundsViscosity: 1.0, attributionControl: false
            });
            
            L.tileLayer('/tiles/{z}/{x}/{y}.png', {maxZoom: NITK.maxZoom, minZoom: NITK.minZoom}).addTo(map);
            
            L.rectangle([[NITK.bounds.south, NITK.bounds.west], [NITK.bounds.north, NITK.bounds.east]], {
                color: '#007AFF', weight: 2, fillOpacity: 0, dashArray: '10,10', interactive: false
            }).addTo(map);
            
            L.marker(NITK.center).addTo(map).bindPopup('<div style="text-align:center"><h4>🏛️ NITK Surathkal</h4></div>');
        }
        
        async function updateData() {
            try {
                const res = await fetch('/api/realtime');
                const data = await res.json();
                document.getElementById('aqi').textContent = data.aqi || '--';
                document.getElementById('pm25').textContent = data.pm25?.toFixed(1) || '--';
                document.getElementById('pm10').textContent = data.pm10?.toFixed(1) || '--';
                document.getElementById('temp').textContent = data.temperature?.toFixed(1) || '--';
                document.getElementById('humidity').textContent = data.humidity?.toFixed(0) || '--';
                document.getElementById('aqi-status').textContent = getAQIStatus(data.aqi);
                document.getElementById('aqi').style.color = getAQIColor(data.aqi);
                document.getElementById('status').textContent = 'System Active';
                
                // Update live metrics if collecting
                if (isCollecting) {
                    document.getElementById('livePM25').textContent = data.pm25?.toFixed(1) || '--';
                    document.getElementById('livePM10').textContent = data.pm10?.toFixed(1) || '--';
                    document.getElementById('liveTemp').textContent = data.temperature?.toFixed(1) || '--';
                    document.getElementById('liveHumidity').textContent = data.humidity?.toFixed(0) || '--';
                }
                
                return data;
            } catch(e) {
                document.getElementById('status').textContent = 'Offline Mode';
                return null;
            }
        }
        
        function getAQIStatus(aqi) {
            if (!aqi) return 'No Data';
            if (aqi <= 50) return '😊 Good';
            if (aqi <= 100) return '😐 Moderate';
            if (aqi <= 150) return '😷 Unhealthy for Sensitive';
            if (aqi <= 200) return '😨 Unhealthy';
            return '😱 Very Unhealthy';
        }
        
        function getAQIColor(aqi) {
            if (!aqi) return '#999';
            if (aqi <= 50) return '#4CAF50';
            if (aqi <= 100) return '#FFC107';
            if (aqi <= 150) return '#FF9800';
            if (aqi <= 200) return '#F44336';
            return '#9C27B0';
        }
        
        function getAQIClass(aqi) {
            if (aqi <= 50) return 'aqi-good';
            if (aqi <= 100) return 'aqi-moderate';
            if (aqi <= 150) return 'aqi-unhealthy-sensitive';
            if (aqi <= 200) return 'aqi-unhealthy';
            return 'aqi-very-unhealthy';
        }
        
        function openCollectionCard() {
            const card = document.getElementById('collectionCard');
            const fab = document.getElementById('fabBtn');
            
            card.classList.add('visible');
            fab.classList.add('hidden');
            
            // Set default coordinates to map center
            const center = map.getCenter();
            document.getElementById('latitude').value = center.lat.toFixed(6);
            document.getElementById('longitude').value = center.lng.toFixed(6);
            
            // Reset form state
            resetCollectionForm();
        }
        
        function closeCollectionCard() {
            const card = document.getElementById('collectionCard');
            const fab = document.getElementById('fabBtn');
            
            // Stop any ongoing collection
            if (isCollecting) {
                stopCollection();
            }
            
            card.classList.remove('visible');
            fab.classList.remove('hidden');
            
            setTimeout(() => {
                resetCollectionForm();
                card.classList.remove('minimized');
                isMinimized = false;
                updateMinimizeButton();
            }, 400);
        }
        
        function toggleMinimize() {
            const card = document.getElementById('collectionCard');
            isMinimized = !isMinimized;
            
            if (isMinimized) {
                card.classList.add('minimized');
            } else {
                card.classList.remove('minimized');
            }
            
            updateMinimizeButton();
        }
        
        function updateMinimizeButton() {
            const btn = document.getElementById('minimizeBtn');
            btn.textContent = isMinimized ? '+' : '−';
        }
        
        function resetCollectionForm() {
            // Reset form
            document.getElementById('location').value = '';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'flex';
            document.getElementById('quickActions').style.display = 'none';
            document.getElementById('startBtn').textContent = 'Start Collection';
            document.getElementById('cardTitle').textContent = '📊 Data Collection';
            
            // Reset progress
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressStats').textContent = '0% • 0s / 120s';
            
            // Clear chart
            if (liveChart) {
                liveChart.destroy();
                liveChart = null;
            }
            
            // Reset collection state
            isCollecting = false;
            collectionData = [];
            
            // Remove collecting animation
            document.getElementById('collectionCard').classList.remove('collecting');
        }
        
        function initChart() {
            const ctx = document.getElementById('liveChart').getContext('2d');
            liveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'PM2.5',
                        data: [],
                        borderColor: '#007AFF',
                        backgroundColor: 'rgba(0, 122, 255, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'PM10',
                        data: [],
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {position: 'top'},
                        title: {display: true, text: 'Live Sensor Data'}
                    },
                    scales: {
                        y: {
                            title: {display: true, text: 'PM (μg/m³)'}
                        }
                    }
                }
            });
        }
        
        async function startCollection(e) {
            e.preventDefault();
            
            const location = document.getElementById('location').value;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            
            // Validate coordinates
            if (lat < NITK.bounds.south || lat > NITK.bounds.north || 
                lng < NITK.bounds.west || lng > NITK.bounds.east) {
                alert('Coordinates must be within NITK campus bounds!');
                return;
            }
            
            // Start collection
            isCollecting = true;
            collectionData = [];
            collectionStartTime = Date.now();
            
            // Update UI
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('quickActions').style.display = 'flex';
            document.getElementById('cardTitle').textContent = `🔴 Collecting: ${location}`;
            document.getElementById('collectionCard').classList.add('collecting');
            
            // Initialize chart
            initChart();
            
            // Update collection status
            document.getElementById('collection-status').innerHTML = 
                `<div style="color: #f44336;">🔴 <strong>Collecting data at ${location}</strong><br>
                <small>Duration: 2 minutes • Live monitoring active</small></div>`;
            
            // Start progress tracking
            let elapsed = 0;
            collectionInterval = setInterval(() => {
                elapsed++;
                const progress = (elapsed / COLLECTION_DURATION) * 100;
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressStats').textContent = 
                    `${Math.round(progress)}% • ${elapsed}s / ${COLLECTION_DURATION}s`;
                
                if (elapsed >= COLLECTION_DURATION) {
                    completeCollection(location, lat, lng);
                }
            }, 1000);
            
            // Start data collection
            updateInterval = setInterval(async () => {
                const data = await updateData();
                if (data) {
                    collectionData.push(data);
                    
                    // Update chart
                    const timeLabel = new Date().toLocaleTimeString();
                    liveChart.data.labels.push(timeLabel);
                    liveChart.data.datasets[0].data.push(data.pm25);
                    liveChart.data.datasets[1].data.push(data.pm10);
                    
                    // Keep only last 15 points
                    if (liveChart.data.labels.length > 15) {
                        liveChart.data.labels.shift();
                        liveChart.data.datasets.forEach(dataset => dataset.data.shift());
                    }
                    
                    liveChart.update();
                }
            }, 4000);
        }
        
        function stopCollection() {
            if (collectionInterval) {
                clearInterval(collectionInterval);
                collectionInterval = null;
            }
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            isCollecting = false;
            document.getElementById('collectionCard').classList.remove('collecting');
            document.getElementById('collection-status').innerHTML = 
                'Collection stopped manually. Ready for new collection.';
            
            resetCollectionForm();
        }
        
        async function completeCollection(location, lat, lng) {
            // Stop intervals
            clearInterval(collectionInterval);
            clearInterval(updateInterval);
            
            try {
                // Save to database
                const res = await fetch('/api/collect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        locationName: location,
                        latitude: lat,
                        longitude: lng,
                        duration: COLLECTION_DURATION
                    })
                });
                const result = await res.json();
                
                // Calculate averages for display
                const avgData = {
                    pm25: collectionData.reduce((sum, d) => sum + d.pm25, 0) / collectionData.length,
                    pm10: collectionData.reduce((sum, d) => sum + d.pm10, 0) / collectionData.length,
                    temperature: collectionData.reduce((sum, d) => sum + d.temperature, 0) / collectionData.length,
                    humidity: collectionData.reduce((sum, d) => sum + d.humidity, 0) / collectionData.length
                };
                
                // Store data
                allReadings[result.id || Date.now()] = {
                    location: location,
                    data: result,
                    collectionData: collectionData,
                    avgData: avgData
                };
                
                // Add marker to map
                addDataMarker(location, lat, lng, result);
                
                // Update UI
                document.getElementById('progressFill').style.background = '#4CAF50';
                document.getElementById('progressStats').textContent = '✅ Collection Complete!';
                document.getElementById('cardTitle').textContent = '✅ Collection Complete';
                
                document.getElementById('collection-status').innerHTML = 
                    `<div style="color: #4CAF50;">
                        ✅ <strong>${location}</strong> collection completed<br>
                        <small>AQI: ${result.aqi} • PM2.5: ${result.pm25.toFixed(1)} μg/m³ • 
                        ${new Date().toLocaleTimeString()}</small>
                    </div>`;
                
                // Auto-minimize after 3 seconds
                setTimeout(() => {
                    if (!isMinimized) {
                        toggleMinimize();
                    }
                }, 3000);
                
                // Auto-close after 5 seconds
                setTimeout(() => {
                    closeCollectionCard();
                }, 8000);
                
            } catch(e) {
                alert('Failed to save collection: ' + e.message);
                stopCollection();
            }
            
            isCollecting = false;
            document.getElementById('collectionCard').classList.remove('collecting');
        }
        
        function addDataMarker(location, lat, lng, data) {
            const readingId = data.id || Date.now();
            const className = getAQIClass(data.aqi);
            
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'aqi-marker ' + className,
                    html: `<div class="aqi-marker ${className}">${data.aqi}</div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                })
            }).addTo(map);
            
            const popupContent = createDetailedPopup(location, data, readingId);
            marker.bindPopup(popupContent, {maxWidth: 400});
        }
        
        function createDetailedPopup(location, data, readingId) {
            return `
                <div style="text-align: center; min-width: 300px;">
                    <h4 style="margin: 0 0 12px 0; color: #333;">${location}</h4>
                    <div style="font-size: 36px; font-weight: bold; color: ${getAQIColor(data.aqi)}; margin: 12px 0;">
                        ${data.aqi}
                    </div>
                    <div style="color: #666; margin-bottom: 16px;">${getAQIStatus(data.aqi)}</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0;">
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <strong style="display: block; font-size: 18px; color: #333;">${data.pm25.toFixed(1)}</strong>
                            <span style="font-size: 12px; color: #666;">PM2.5 μg/m³</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <strong style="display: block; font-size: 18px; color: #333;">${data.pm10.toFixed(1)}</strong>
                            <span style="font-size: 12px; color: #666;">PM10 μg/m³</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <strong style="display: block; font-size: 18px; color: #333;">${data.temperature?.toFixed(1) || '--'}°C</strong>
                            <span style="font-size: 12px; color: #666;">Temperature</span>
                        </div>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <strong style="display: block; font-size: 18px; color: #333;">${data.humidity?.toFixed(0) || '--'}%</strong>
                            <span style="font-size: 12px; color: #666;">Humidity</span>
                        </div>
                    </div>
                    
                    <div style="font-size: 12px; color: #999; padding-top: 12px; border-top: 1px solid #eee;">
                        📅 ${new Date(data.timestamp).toLocaleString()}<br>
                        📍 ${data.latitude?.toFixed(6) || lat.toFixed(6)}, ${data.longitude?.toFixed(6) || lng.toFixed(6)}
                    </div>
                </div>
            `;
        }
        
        // Initialize
        initMap();
        updateData();
        setInterval(updateData, 5000);
        
        // Load existing data points (this would come from your API)
        // fetch('/api/readings').then(res => res.json()).then(data => {
        //     if (data.readings) {
        //         data.readings.forEach(reading => {
        //             if (reading.location_name && reading.latitude && reading.longitude) {
        //                 const readingData = {
        //                     id: reading.id,
        //                     aqi: reading.aqi,
        //                     pm25: reading.pm25,
        //                     pm10: reading.pm10,
        //                     temperature: reading.temp,
        //                     humidity: reading.humidity,
        //                     timestamp: reading.timestamp,
        //                     latitude: reading.latitude,
        //                     longitude: reading.longitude
        //                 };
        //                 
        //                 allReadings[reading.id] = {
        //                     location: reading.location_name,
        //                     data: readingData,
        //                     collectionData: [],
        //                     avgData: {}
        //                 };
        //                 
        //                 addDataMarker(reading.location_name, reading.latitude, reading.longitude, readingData);
        //             }
        //         });
        //     }
        // });
    </script>
</body>
</html>